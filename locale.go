package i18n

import (
	"strings"
	"sync"

	"golang.org/x/text/language"
)

// preferredRegionForLanguage provides explicit region picks for common/multiâ€‘region languages.
// These entries take precedence when building the full DefaultLocale map.
var preferredRegionForLanguage = map[string]string{
	"ar": "AE",
	"en": "US",
	"fr": "FR",
	"es": "ES",
	"de": "DE",
	"it": "IT",
	"pt": "PT", // prefer PT; adjust to BR if your product expects Brazilian Portuguese by default
	"zh": "CN",
	"ja": "JP",
	"ko": "KR",
	"nl": "NL",
	"sv": "SE",
	"nb": "NO",
	"nn": "NO",
	"cs": "CZ",
	"da": "DK",
	"fi": "FI",
	"el": "GR",
	"he": "IL",
	"hi": "IN",
	"id": "ID",
	"ms": "MY",
	"pl": "PL",
	"ro": "RO",
	"sk": "SK",
	"sl": "SI",
	"tr": "TR",
	"uk": "UA",
	"vi": "VN",
	"th": "TH",
	"bg": "BG",
	"hr": "HR",
	"hu": "HU",
	"sr": "RS",
	"sq": "AL",
	"ca": "ES",
	"et": "EE",
	"lv": "LV",
	"lt": "LT",
	"is": "IS",
	"mt": "MT",
	"mk": "MK",
	"sw": "KE",
	"ta": "LK",
	"ur": "PK",
	"fa": "IR",
	"bn": "BD",
	"si": "LK",
	"km": "KH",
	"lo": "LA",
	"my": "MM",
	"ne": "NP",
	"am": "ET",
	"tg": "TJ",
	"tk": "TM",
	"uz": "UZ",
	"kk": "KZ",
	"ky": "KG",
	"az": "AZ",
	"hy": "AM",
	"ka": "GE",
	"ps": "AF",
	"dv": "MV",
	"dz": "BT",
	"ti": "ER",
	"so": "SO",
	"af": "ZA",
	"xh": "ZA",
	"zu": "ZA",
	"st": "ZA",
	"tn": "ZA",
	"ts": "ZA",
	"ve": "ZA",
	"ss": "ZA",
	"rn": "BI",
	"rw": "RW",
}

// regionPreferenceOrder provides a general fallback priority when picking a default region.
// It improves determinism for widely spoken languages if no explicit preference is set.
var regionPreferenceOrder = []string{
	"US", "GB", "DE", "FR", "ES", "IT", "PT", "BR", "CN", "TW", "HK", "JP", "KR",
	"RU", "IN", "CA", "AU", "MX", "AR", "CL", "CO", "PE", "ZA", "SE", "NO", "DK", "FI",
	"NL", "BE", "CH", "AT", "PL", "CZ", "SK", "HU", "RO", "BG", "GR", "TR", "IL", "AE",
	"SA", "EG", "MA", "DZ", "TN", "IQ", "IR", "PK", "BD", "LK", "NP", "TH", "VN", "ID",
	"MY", "SG", "PH", "KH", "LA", "MM", "UA", "BY", "KZ", "UZ", "TJ", "TM", "AZ", "AM",
	"GE", "IE", "IS", "LT", "LV", "EE", "SI", "HR", "BA", "RS", "ME", "MK", "AL", "XK",
	"CY", "MT", "LU", "LI", "MC", "AD", "SM", "VA", "NZ",
}

var SupportedLocale = map[string]bool{
	"aa-ER":  true,
	"af-NA":  true,
	"af-ZA":  true,
	"am-ET":  true,
	"ar-AE":  true,
	"ar-BH":  true,
	"ar-DJ":  true,
	"ar-DZ":  true,
	"ar-EG":  true,
	"ar-ER":  true,
	"ar-IL":  true,
	"ar-IQ":  true,
	"ar-JO":  true,
	"ar-KM":  true,
	"ar-KW":  true,
	"ar-LB":  true,
	"ar-LY":  true,
	"ar-MA":  true,
	"ar-MR":  true,
	"ar-OM":  true,
	"ar-PS":  true,
	"ar-QA":  true,
	"ar-SA":  true,
	"ar-SD":  true,
	"ar-SO":  true,
	"ar-SY":  true,
	"ar-TD":  true,
	"ar-TN":  true,
	"ar-YE":  true,
	"ay-BO":  true,
	"az-AZ":  true,
	"be-BY":  true,
	"bg-BG":  true,
	"bi-VU":  true,
	"bn-BD":  true,
	"bs-BA":  true,
	"bs-ME":  true,
	"byn-ER": true,
	"ca-AD":  true,
	"ch-GU":  true,
	"ch-MP":  true,
	"cs-CZ":  true,
	"da-DK":  true,
	"de-AT":  true,
	"de-BE":  true,
	"de-CH":  true,
	"de-DE":  true,
	"de-LI":  true,
	"de-LU":  true,
	"de-VA":  true,
	"dv-MV":  true,
	"dz-BT":  true,
	"el-CY":  true,
	"el-GR":  true,
	"en-AG":  true,
	"en-AI":  true,
	"en-AQ":  true,
	"en-AS":  true,
	"en-AU":  true,
	"en-BB":  true,
	"en-BM":  true,
	"en-BS":  true,
	"en-BW":  true,
	"en-BZ":  true,
	"en-CA":  true,
	"en-CC":  true,
	"en-CK":  true,
	"en-CM":  true,
	"en-CW":  true,
	"en-CX":  true,
	"en-DM":  true,
	"en-ER":  true,
	"en-FJ":  true,
	"en-FK":  true,
	"en-FM":  true,
	"en-GB":  true,
	"en-GD":  true,
	"en-GG":  true,
	"en-GH":  true,
	"en-GI":  true,
	"en-GM":  true,
	"en-GS":  true,
	"en-GU":  true,
	"en-GY":  true,
	"en-HK":  true,
	"en-HM":  true,
	"en-IE":  true,
	"en-IM":  true,
	"en-IN":  true,
	"en-IO":  true,
	"en-JE":  true,
	"en-JM":  true,
	"en-KE":  true,
	"en-KI":  true,
	"en-KN":  true,
	"en-KY":  true,
	"en-LC":  true,
	"en-LR":  true,
	"en-LS":  true,
	"en-MF":  true,
	"en-MH":  true,
	"en-MP":  true,
	"en-MS":  true,
	"en-MT":  true,
	"en-MU":  true,
	"en-MW":  true,
	"en-NA":  true,
	"en-NF":  true,
	"en-NG":  true,
	"en-NR":  true,
	"en-NU":  true,
	"en-NZ":  true,
	"en-PG":  true,
	"en-PH":  true,
	"en-PK":  true,
	"en-PN":  true,
	"en-PR":  true,
	"en-PW":  true,
	"en-RW":  true,
	"en-SB":  true,
	"en-SC":  true,
	"en-SD":  true,
	"en-SG":  true,
	"en-SH":  true,
	"en-SL":  true,
	"en-SS":  true,
	"en-SX":  true,
	"en-SZ":  true,
	"en-TC":  true,
	"en-TK":  true,
	"en-TO":  true,
	"en-TT":  true,
	"en-TV":  true,
	"en-TZ":  true,
	"en-UG":  true,
	"en-UM":  true,
	"en-US":  true,
	"en-VC":  true,
	"en-VG":  true,
	"en-VI":  true,
	"en-VU":  true,
	"en-WS":  true,
	"en-ZA":  true,
	"en-ZM":  true,
	"en-ZW":  true,
	"es-AR":  true,
	"es-BO":  true,
	"es-BZ":  true,
	"es-CL":  true,
	"es-CO":  true,
	"es-CR":  true,
	"es-CU":  true,
	"es-DO":  true,
	"es-EC":  true,
	"es-EH":  true,
	"es-ES":  true,
	"es-GQ":  true,
	"es-GT":  true,
	"es-GU":  true,
	"es-HN":  true,
	"es-MX":  true,
	"es-NI":  true,
	"es-PA":  true,
	"es-PE":  true,
	"es-PR":  true,
	"es-PY":  true,
	"es-SV":  true,
	"es-UY":  true,
	"es-VE":  true,
	"et-EE":  true,
	"fa-IR":  true,
	"fan-GQ": true,
	"ff-BF":  true,
	"ff-GN":  true,
	"fi-FI":  true,
	"fj-FJ":  true,
	"fo-FO":  true,
	"fr-BE":  true,
	"fr-BF":  true,
	"fr-BI":  true,
	"fr-BJ":  true,
	"fr-BL":  true,
	"fr-CA":  true,
	"fr-CD":  true,
	"fr-CF":  true,
	"fr-CG":  true,
	"fr-CH":  true,
	"fr-CI":  true,
	"fr-CM":  true,
	"fr-DJ":  true,
	"fr-FR":  true,
	"fr-GA":  true,
	"fr-GF":  true,
	"fr-GG":  true,
	"fr-GN":  true,
	"fr-GP":  true,
	"fr-GQ":  true,
	"fr-HT":  true,
	"fr-JE":  true,
	"fr-KM":  true,
	"fr-LB":  true,
	"fr-LU":  true,
	"fr-MC":  true,
	"fr-MF":  true,
	"fr-MG":  true,
	"fr-ML":  true,
	"fr-MQ":  true,
	"fr-NC":  true,
	"fr-NE":  true,
	"fr-PF":  true,
	"fr-PM":  true,
	"fr-RE":  true,
	"fr-RW":  true,
	"fr-SC":  true,
	"fr-SN":  true,
	"fr-TD":  true,
	"fr-TF":  true,
	"fr-TG":  true,
	"fr-VA":  true,
	"fr-VU":  true,
	"fr-WF":  true,
	"fr-YT":  true,
	"ga-IE":  true,
	"gn-AR":  true,
	"gn-PY":  true,
	"gv-IM":  true,
	"he-IL":  true,
	"hi-IN":  true,
	"hif-FJ": true,
	"hr-BA":  true,
	"hr-HR":  true,
	"hr-ME":  true,
	"ht-HT":  true,
	"hu-HU":  true,
	"hy-AM":  true,
	"hy-CY":  true,
	"id-ID":  true,
	"is-IS":  true,
	"it-CH":  true,
	"it-IT":  true,
	"it-SM":  true,
	"it-VA":  true,
	"ja-JP":  true,
	"ka-GE":  true,
	"kg-CD":  true,
	"kk-KZ":  true,
	"kl-GL":  true,
	"km-KH":  true,
	"ko-KP":  true,
	"ko-KR":  true,
	"ku-IQ":  true,
	"kun-ER": true,
	"ky-KG":  true,
	"la-VA":  true,
	"lb-LU":  true,
	"ln-CD":  true,
	"ln-CG":  true,
	"lo-LA":  true,
	"lt-LT":  true,
	"lu-CD":  true,
	"lv-LV":  true,
	"mg-MG":  true,
	"mh-MH":  true,
	"mi-NZ":  true,
	"mk-MK":  true,
	"mn-MN":  true,
	"ms-BN":  true,
	"ms-MY":  true,
	"ms-SG":  true,
	"mt-MT":  true,
	"my-MM":  true,
	"na-NR":  true,
	"nb-BV":  true,
	"nb-NO":  true,
	"nd-ZW":  true,
	"ne-NP":  true,
	"nl-AW":  true,
	"nl-BE":  true,
	"nl-BQ":  true,
	"nl-CW":  true,
	"nl-MF":  true,
	"nl-NL":  true,
	"nl-SR":  true,
	"nl-SX":  true,
	"nn-BV":  true,
	"nn-NO":  true,
	"no-BV":  true,
	"no-NO":  true,
	"no-SJ":  true,
	"nr-ZA":  true,
	"nrb-ER": true,
	"ny-MW":  true,
	"pa-AW":  true,
	"pa-CW":  true,
	"pl-PL":  true,
	"ps-AF":  true,
	"pt-AO":  true,
	"pt-BR":  true,
	"pt-CV":  true,
	"pt-GQ":  true,
	"pt-GW":  true,
	"pt-MO":  true,
	"pt-MZ":  true,
	"pt-PT":  true,
	"pt-ST":  true,
	"pt-TL":  true,
	"qu-BO":  true,
	"rar-CK": true,
	"rm-CH":  true,
	"rn-BI":  true,
	"ro-MD":  true,
	"ro-RO":  true,
	"rtm-FJ": true,
	"ru-AQ":  true,
	"ru-BY":  true,
	"ru-KG":  true,
	"ru-KZ":  true,
	"ru-RU":  true,
	"ru-TJ":  true,
	"ru-TM":  true,
	"ru-UZ":  true,
	"rw-RW":  true,
	"sg-CF":  true,
	"si-LK":  true,
	"sk-CZ":  true,
	"sk-SK":  true,
	"sl-SI":  true,
	"sm-AS":  true,
	"sm-WS":  true,
	"sn-ZW":  true,
	"so-SO":  true,
	"sq-AL":  true,
	"sq-ME":  true,
	"sq-XK":  true,
	"sr-BA":  true,
	"sr-ME":  true,
	"sr-RS":  true,
	"sr-XK":  true,
	"ss-SZ":  true,
	"ss-ZA":  true,
	"ssy-ER": true,
	"st-LS":  true,
	"st-ZA":  true,
	"sv-AX":  true,
	"sv-FI":  true,
	"sv-SE":  true,
	"sw-CD":  true,
	"sw-KE":  true,
	"sw-TZ":  true,
	"sw-UG":  true,
	"ta-LK":  true,
	"ta-SG":  true,
	"tg-TJ":  true,
	"th-TH":  true,
	"ti-ER":  true,
	"tig-ER": true,
	"tk-AF":  true,
	"tk-TM":  true,
	"tn-BW":  true,
	"tn-ZA":  true,
	"to-TO":  true,
	"tr-CY":  true,
	"tr-TR":  true,
	"ts-ZA":  true,
	"uk-UA":  true,
	"ur-PK":  true,
	"uz-AF":  true,
	"uz-UZ":  true,
	"ve-ZA":  true,
	"vi-VN":  true,
	"xh-ZA":  true,
	"zh-CN":  true,
	"zh-HK":  true,
	"zh-MO":  true,
	"zh-SG":  true,
	"zh-TW":  true,
	"zu-ZA":  true,
}

// BCP47 builds and parses a canonical BCP-47 tag using the provided optional country (region) and language.
// - country should be ISO 3166-1 alpha-2 (e.g., "US").
// - language should be ISO 639-1 (e.g., "en").
// If country is given but language is empty, the country's default language from CountryLanguages is used.
// If both are empty, English ("en") is used.
func BCP47(country, lang string) language.Tag {
	c := strings.ToUpper(strings.TrimSpace(country))
	l := strings.ToLower(strings.TrimSpace(lang))

	if cached, ok := cachedLocale[c+l]; ok {
		return cached
	}

	cacheLock.Lock()
	defer cacheLock.Unlock()

	if _, ok := SupportedLocale[l+"-"+c]; ok {
		tg := language.Make(l + "-" + c)
		cachedLocale[c+l] = tg
		return tg
	}

	c = preferredRegionForLanguage[l]
	if _, ok := SupportedLocale[l+"-"+c]; ok {
		tg := language.Make(l + "-" + c)
		cachedLocale[c+l] = tg
		return tg
	}

	cachedLocale[c+l] = language.AmericanEnglish
	return language.AmericanEnglish
}

var cacheLock sync.Mutex
var cachedLocale = map[string]language.Tag{
	"enGB": language.BritishEnglish,
	"enUS": language.AmericanEnglish,
}
